# Gemini 工作区规则

本文档记录了在此项目中与 Gemini 协作时需要遵守的特定规则和约定。

## 编码与开发

- **规则 1:** 不在正式的应用模块代码中编写测试或生成虚拟数据（dummy data）的函数。所有测试都应通过运行正式代码来完成。
- **规则 2:** 所有系统设计、代码实现和交互建议都必须达到生产级实盘交易的标准。严禁使用“初期简化”、“临时占位”或不严谨的快捷方式，除非用户明确要求制作原型。
- **规则 3:** **严禁使用 `print()` 进行日志输出**。
    - 生产环境代码（`server/` 目录下所有模块）必须使用 Python 标准库 `logging` 模块。
    - 仅允许在 CLI 工具脚本（如 `manage.py`）或一次性诊断脚本中使用 `print` 与用户交互。
- **规则 4:** 防止 Windows 平台乱码的强制规范：
    1. **执行命令前**: 必须在 Shell 会话中显式设置编码为 UTF-8 (例如 PowerShell 中执行 `$OutputEncoding = [System.Console]::InputEncoding = [System.Console]::OutputEncoding = [System.Text.Encoding]::UTF8`)。
    2. **Python 脚本**: 执行时必须设置环境变量 `PYTHONIOENCODING="utf-8"`。
    3. **日志查看**: 严禁直接依赖控制台输出来查看包含中文的长日志，必须重定向到文件（`> log.txt 2>&1`）后通过文本编辑器或支持编码的文件读取工具查看。
    4. **交互输出**: 确保所有工具调用返回的文本内容（如错误信息、状态报告）在呈现给用户前已正确解码，避免在交互过程中出现乱码。
    5. **源码文件**: 确保所有包含非 ASCII 字符的源码文件均以 UTF-8 编码保存。
- **规则 5:** **服务端口规范**:
    - 后端服务默认使用端口 **8001** (避免 Windows 下 8000 端口常被僵尸进程占用)。
    - 前端服务默认使用端口 **3000**。

## 交互偏好

- 用户偏好使用中文进行交互。

## 架构执行记录 (2025-12-13)

- **性能优化**: 针对外网开发场景进行了严格的基准测试 (`benchmark_comparison.py`)。结果显示 SSH 隧道连接（~225ms）比内网直连（~1.7ms）慢约 135 倍。
- **配置标准化**: 更新 `.env.example`，明确区分“内网高性能”与“外网 SSH”两套配置模板，并将内网配置设为默认推荐，以确保生产环境性能。
- **架构强化**: 重构服务启动流程 (`manage.py`)，将数据库迁移 (`alembic upgrade`) 剥离为启动前的串行独立进程。解决了 Windows 下 Alembic 与 SSH 隧道在子进程中并发执行导致的死锁/崩溃问题，确保了“启动即自动建表”的健壮性。
- **功能增强**: 实现了智能 SSH 隧道 (`server/storage/database.py`)。单例模式管理隧道连接，支持自动检测运行环境：服务器本机直连（零性能损耗），远程开发自动建立隧道。
- **代码修正**: 修复了 Alembic 迁移脚本 (`60d403367b7a`)，增加了对 PostgreSQL `ENUM` 类型的清理逻辑 (`DROP TYPE IF EXISTS ... CASCADE`)，解决了数据库重建时的类型冲突。
- **当前状态**: 环境自愈能力已验证。无论数据库是否为空，执行 `python manage.py start` 均可自动完成初始化并提供服务。

## 架构执行记录 (2025-12-07)

- **清理操作**: 删除 `test_events_generator.py`，因为其违反了“无独立脚本”及“API 不暴露事件创建接口”的架构规则。
- **代码修正**: 清理 `server/api/v1/events.py` 中未使用的 `record_event` 引用，强化 API 的只读属性。
- **功能实现**: 完成 `server/etl/runner.py`，实现 ETL 任务的加载、执行及全生命周期事件记录。
- **功能增强**: 升级 `server/api/v1/etl.py`，支持 CSV 文件的预览，并优化代码结构。
- **当前状态**: ETL 系统（Runner & API）已就绪，可进行端到端使用或测试。