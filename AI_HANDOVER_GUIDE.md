# AI 交接指南 (AI Handover Guide)

本文档旨在为接手本项目标 AI 或开发人员提供全面、精准的上下文信息，确保在无需查阅大量历史记录的情况下，能够快速理解项目状况并开展工作。

## 1. 项目核心目标

构建一个健壮、可扩展的量化交易系统。其核心特性是拥有一个基于**事件驱动**架构的、可通过 Web 实时监控的仪表盘。

## 2. 核心架构与设计原则 (最重要)

本项目的架构经过了关键演进，最终确立了以**数据库为核心的事件驱动模型**。理解这一点是开展所有工作的基础。

### 2.1. 数据流

1.  **事件产生 (内部)**: 所有的业务逻辑（如 ETL、回测）都作为后台任务在 FastAPI 服务进程内部运行。在关键节点，这些任务**必须通过直接调用 `server.common.event_service.record_event()` 函数**来记录事件。
2.  **事件存储**: `record_event()` 函数会获取一个数据库会话，并将结构化的事件数据直接存入 PostgreSQL 数据库。
3.  **API 服务 (只读)**: FastAPI 对外暴露**只读**的 API 接口（如 `GET /api/v1/events`），供前端查询事件数据。
4.  **前端监控**: React 前端通过定时**轮询 (Polling)** 上述 API 接口获取最新数据，并刷新监控图表。

### 2.2. 关键设计决策 (必须遵守)

-   **严禁外部创建事件**: 系统**绝不**提供任何用于创建事件的外部 `POST` 接口。这是为了保证事件的真实性和一致性，所有事件都必须由系统内部的业务逻辑产生。最初设计的 `POST /api/v1/events` 接口已被明确移除。
-   **数据库是唯一事实来源**: 整个系统的状态都通过存储在数据库中的事件来反映。数据库是解耦各个组件的中心枢纽。
-   **无状态的 API**: 后端 API 自身是无状态的，仅作为数据库数据的查询代理。
-   **Alembic 是唯一的数据库迁移工具**: 所有对数据库表结构的修改，都**必须**通过 `alembic` 生成迁移脚本来完成，严禁手动修改数据库。

### 架构图

```
+-----------------------------------------------------+
| FastAPI 服务                                        |
|                                                     |
|  +-----------------+   record_event()   +---------+  |
|  |   后台任务(ETL)   | -----------------> | Event   |  |
|  +-----------------+      (函数调用)      | Service |----->[ PostgreSQL 数据库 ]
|                                          +---------+  |         ^
|  +-----------------+   record_event()         ^        |         |
|  |  后台任务(回测) | ----------------->        |        |         |
|  +-----------------+      (函数调用)            |        |         |
|                               _ _ _ _ _ _ _ _ _ | _ _ _ _ _ _ _ _ _ |
|                              |                  | (DB Session)    |
|                              |                  |                 |
|                        +--------------------------------+         |
|                        |     GET /api/v1/events         |         |
|                        +--------------------------------+         |
|                        +--------------------------------+         |
|                                      ^                            |
+--------------------------------------|----------------------------+
                                       | (HTTP Polling)
                                       |
                             +------------------+
                             |  React 监控前端  |
                             +------------------+
```

## 3. 技术栈

-   **后端**: Python 3.10+, FastAPI, SQLAlchemy (ORM), `asyncpg` (异步驱动), Alembic, Uvicorn
-   **数据库**: PostgreSQL
-   **前端**: React 18, Vite, Tailwind CSS, Axios
-   **核心依赖**: `pandas` (用于数据处理)

## 4. 项目级规则与约定 (GEMINI.md)

项目根目录下的 `GEMINI.md` 文件记录了在开发过程中形成的重要约定，接手者必须阅读并遵守。

-   **核心规则 1**: 不在正式的应用模块代码中编写测试或生成虚拟数据（dummy data）的函数。所有测试都应通过运行正式代码来完成。

## 5. 项目结构

```
easyquant/
├── .env                    # (需手动创建) 环境变量文件
├── .git/
├── alembic/                # Alembic 数据库迁移目录
├── client/                 # React 前端应用
├── server/
│   ├── api/                # API 路由模块 (只读)
│   │   └── v1/
│   │       └── events.py   # v1 版本的事件查询 API
│   ├── common/             # 后端内部通用模块
│   │   └── event_service.py# 核心事件记录服务 (唯一入口)
│   ├── etl/                # ETL 模块
│   │   └── data_loader/    # 数据加载器 (e.g., csv_loader.py)
│   ├── backtest/           # 回测模块
│   ├── live/               # 实盘模块
│   ├── storage/            # 数据存储模块
│   │   ├── database.py     # 数据库连接与会话管理
│   │   └── models/         # SQLAlchemy 数据模型
│   └── main.py             # 系统主入口
├── AI_HANDOVER_GUIDE.md    # 本文档
├── devlog.md               # 开发日志 (历史参考)
├── GEMINI.md               # 项目开发规则
├── README.md               # 项目主说明文档
└── requirements.txt        # Python 依赖
```

## 6. 环境设置与启动

1.  **安装依赖**: `pip install -r requirements.txt`
2.  **配置环境变量**:
    - 在项目根目录创建 `.env` 文件。
    - 文件中必须包含数据库连接字符串:
      `DATABASE_URL="postgresql+asyncpg://user:password@host/dbname"`
    - **程序在启动时会检查此变量，如果缺失会直接报错。**
3.  **数据库迁移**: `alembic upgrade head` (此命令会根据 `server/storage/models` 中的定义创建表)。
4.  **启动服务**: `python server/main.py`

## 7. 当前项目状态与进度 (截至 2025-12-06)

-   [x] **完成核心架构设计与转型**: 从 WebSocket 实时推送模型成功转型为基于数据库的事件驱动模型。
-   [x] **完成后端基础服务**:
    -   FastAPI 应用主体 (`main.py`)。
    -   核心事件记录服务 (`event_service.py`)。
    -   只读的事件查询 API (`api/v1/events.py`)。
    -   高性能的异步数据库核心 (`database.py`)。
-   [x] **完成数据库设计与迁移**:
    -   定义了 `events` 表结构 (`models/event.py`)。
    -   配置了 Alembic 进行数据库版本管理。
-   [x] **完成 ETL 数据加载框架**:
    -   实现了通用的异步数据加载基类 `BaseLoader`。
    -   实现了一个具体的 `CSVLoader`，用于从本地加载 CSV 文件。
-   [x] **完成项目规范化**:
    -   创建了 `README.md`, `devlog.md`, `GEMINI.md` 等关键文档。
    -   建立了明确的开发规则。
-   [ ] **待办事项**:
    -   **数据库迁移**: 用户尚未确认 `.env` 文件已配置，因此还未执行初始的 `alembic upgrade head` 来创建数据表。
    -   **ETL 完整流程**: 当前只有数据加载（Loader），完整的 ETL 流程还需要 `Process` 和 `Storage` 环节的实现。
    -   **回测/实盘模块**: 尚未开始具体业务逻辑的开发。
    -   **前端开发**: 前端已有基本框架，但监控仪表盘的具体图表和功能尚未开发。
