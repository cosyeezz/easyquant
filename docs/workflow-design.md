# EasyQuant å·¥ä½œæµå¼•æ“è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬: v1.2 | æ—¥æœŸ: 2025-12-23 | çŠ¶æ€: Draft

---

## ä¸€ã€è®¾è®¡ç›®æ ‡

æ„å»ºä¸€ä¸ª**ç”Ÿäº§çº§**çš„é€šç”¨é‡åŒ–å·¥ä½œæµå¼•æ“ï¼Œæ ¸å¿ƒå·®å¼‚åŒ–ç‰¹æ€§åœ¨äº **â€œåˆ—çº§åˆ«çš„æ•°æ®æµæ§åˆ¶ (Column-Level Data Flow)â€**ã€‚

ç³»ç»Ÿéœ€æ”¯æŒï¼š
- **ETL æ•°æ®å¤„ç†**ï¼šå¤šæºæ•°æ®æ¸…æ´—ã€åˆå¹¶ã€å…¥åº“ã€‚
- **å› å­æŒ–æ˜**ï¼šåŸºäº DataFrame çš„åˆ—è¿ç®—ä¸ç‰¹å¾å·¥ç¨‹ã€‚
- **ç­–ç•¥å›æµ‹**ï¼šäº‹ä»¶é©±åŠ¨ä¸å‘é‡åŒ–å›æµ‹çš„ç»“åˆã€‚
- **å®ç›˜ä»¿çœŸ**ï¼šå®æ—¶ä¿¡å·æµçš„ç”Ÿæˆä¸æ¨é€ã€‚

---

## äºŒã€æ ¸å¿ƒæ¶æ„æ¦‚å¿µ

### 2.1 æ•°æ®æµå¯¹è±¡ (Data Objects)

å·¥ä½œæµä¸­æµåŠ¨çš„ä¸ä»…ä»…æ˜¯â€œæ•°æ®â€ï¼Œè€Œæ˜¯å¸¦æœ‰å¼ºç±»å‹å…ƒæ•°æ®çš„å¯¹è±¡ã€‚

| ç±»å‹æ ‡è¯† | åç§° | è¯´æ˜ | è½½è· (Payload) | å…ƒæ•°æ® (Schema) |
|:---|:---|:---|:---|:---|
| `df` | DataFrame | æ ‡å‡†è¡¨æ ¼æ•°æ® | `pandas.DataFrame` / `polars.DataFrame` | åˆ—åã€åˆ—ç±»å‹ã€ç´¢å¼•ä¿¡æ¯ |
| `signal` | Signal | äº¤æ˜“ä¿¡å· | æ ‡å‡†åŒ–ä¿¡å·å¯¹è±¡åˆ—è¡¨ | ä¿¡å·ç»“æ„å®šä¹‰ |
| `metric` | Metrics | æ ‡é‡æŒ‡æ ‡ | JSON å¯¹è±¡ (KV pair) | æŒ‡æ ‡åç§°ã€å•ä½ |

### 2.2 ç«¯å£ç³»ç»Ÿ (Port System)

ç«¯å£æ˜¯èŠ‚ç‚¹é—´é€šä¿¡çš„å¥‘çº¦ã€‚

*   **è¾“å…¥ç«¯å£ (Input Port)**
    *   **é™æ€ç«¯å£**: å¦‚ `df` (ä¸»æ•°æ®), `ref` (å‚è€ƒæ•°æ®)ã€‚
    *   **åŠ¨æ€ç«¯å£**: éƒ¨åˆ†èŠ‚ç‚¹ï¼ˆå¦‚ Mergeï¼‰å…è®¸åŠ¨æ€æ·»åŠ  `input_1`, `input_2`...
    *   **çº¦æŸ**: å®šä¹‰äº† `accepted_types` (æ¥å—ç±»å‹) å’Œ `required_columns` (å¿…éœ€åˆ—)ã€‚

*   **è¾“å‡ºç«¯å£ (Output Port)**
    *   **ç¡®å®šæ€§**: æ¯ä¸ªç«¯å£å¿…é¡»æœ‰æ˜ç¡®çš„ Output Schemaã€‚
    *   **å¤šè·¯åˆ†å‘**: ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥äº§ç”Ÿå¤šä¸ªè¾“å‡ºï¼ˆå¦‚ Filter èŠ‚ç‚¹è¾“å‡º `matched` å’Œ `rejected` ä¸¤ä¸ªæµï¼‰ã€‚

### 2.3 èŠ‚ç‚¹ç‰ˆæœ¬æ§åˆ¶ (Versioning)

ä¸ºäº†é˜²æ­¢èŠ‚ç‚¹å®šä¹‰æ›´æ–°ï¼ˆå¦‚ä¿®æ”¹å‚æ•°åï¼‰å¯¼è‡´å­˜é‡å·¥ä½œæµå´©æºƒï¼Œé‡‡ç”¨**å¿«ç…§å¼ç‰ˆæœ¬ç®¡ç†**ï¼š

1.  **èŠ‚ç‚¹å®šä¹‰ç‰ˆæœ¬**: æ¯ä¸ªèŠ‚ç‚¹å®šä¹‰åŒ…å« `version` (e.g., `1.0.0`)ã€‚
2.  **å·¥ä½œæµé”å®š**: å·¥ä½œæµä¿å­˜æ—¶ï¼Œè®°å½•å¼•ç”¨çš„èŠ‚ç‚¹ç‰ˆæœ¬ (`node_type: "csv_loader@1.0.0"`).
3.  **å‡çº§ç­–ç•¥**: ç”¨æˆ·æ‰“å¼€æ—§å·¥ä½œæµæ—¶ï¼Œè‹¥æ£€æµ‹åˆ°æ–°ç‰ˆèŠ‚ç‚¹ï¼Œæç¤ºâ€œæ˜¯å¦å‡çº§èŠ‚ç‚¹ï¼Ÿâ€ï¼Œç‚¹å‡»å‡çº§åè¿›è¡Œå‚æ•°è¿ç§»ã€‚

---

## ä¸‰ã€Schema ä¸åˆ—ç³»ç»Ÿ

### 3.1 åˆ—å®šä¹‰ (Column Definition)

```typescript
interface ColumnDefinition {
  // æ ¸å¿ƒæ ‡è¯†
  name: string;           // åˆ—å (e.g., "close")
  type: ColumnType;       // æ•°æ®ç±»å‹

  // è¡¨ç°å±‚
  title?: string;         // æ˜¾ç¤ºå (e.g., "æ”¶ç›˜ä»·")
  description?: string;   // ä¸šåŠ¡å«ä¹‰æè¿°
  
  // çº¦æŸä¸è¡€ç¼˜
  nullable?: boolean;     // é»˜è®¤ true
  source_node_id?: string;// è¡€ç¼˜è¿½è¸ªï¼šè¯¥åˆ—æœ€æ—©ç”±å“ªä¸ªèŠ‚ç‚¹äº§ç”Ÿ
}
```

### 3.2 ç±»å‹å…¼å®¹æ€§çŸ©é˜µ (Type Compatibility)

å½“ä¸Šæ¸¸åˆ—ç±»å‹ä¸ä¸‹æ¸¸è¦æ±‚ä¸ä¸€è‡´æ—¶ï¼Œå¤„ç†ç­–ç•¥å¦‚ä¸‹ï¼š

| ä¸Šæ¸¸ \ ä¸‹æ¸¸ | String | Number | Boolean | Date | ç­–ç•¥ |
|:---|:---:|:---:|:---:|:---:|:---|
| **String** | âœ… | âš ï¸ | âŒ | âš ï¸ | âš ï¸ å°è¯•è§£æï¼Œå¤±è´¥åˆ™æŠ¥é”™ |
| **Number** | âœ… | âœ… | âœ… | âŒ | âœ… è‡ªåŠ¨è½¬æ¢ (StringåŒ–/é0å³çœŸ) |
| **Boolean**| âœ… | âœ… | âœ… | âŒ | âœ… True=1, False=0 |
| **Date**   | âœ… | âŒ | âŒ | âœ… | âœ… ISOæ ¼å¼åŒ– |

---

## å››ã€é«˜çº§ç‰¹æ€§ (Advanced Features) **[New]**

### 4.1 å…¨å±€ä¸Šä¸‹æ–‡ (Global Context)

è§£å†³å¯†é’¥ç®¡ç†å’Œå…¨å±€å‚æ•°å¤ç”¨é—®é¢˜ã€‚

*   **ç¯å¢ƒå˜é‡**: æ”¯æŒåœ¨ä»»ä½•è¾“å…¥æ¡†ä½¿ç”¨ `${ENV.DB_PASSWORD}` å¼•ç”¨ç³»ç»Ÿå®‰å…¨å˜é‡ã€‚
*   **è¿è¡Œæ—¶å‚æ•°**: æ”¯æŒ `${CTX.START_DATE}`, `${CTX.ASSET_POOL}` ç­‰åŠ¨æ€å‚æ•°ï¼Œåœ¨è§¦å‘ä»»åŠ¡æ—¶æ³¨å…¥ã€‚
*   **å®ç°**: å‰ç«¯è§£æå˜é‡è¯­æ³•å¹¶é«˜äº®æ˜¾ç¤ºï¼Œåç«¯åœ¨æ‰§è¡Œå‰è¿›è¡Œ Template String æ›¿æ¢ã€‚

### 4.2 æ™ºèƒ½ç¼“å­˜ (Smart Caching)

æå‡å¤§æ•°æ®é‡ä¸‹çš„è¿­ä»£æ•ˆç‡ã€‚

*   **æŒ‡çº¹è®¡ç®—**: `CacheKey = Hash(InputDataFingerprint + NodeParams + NodeVersion)`ã€‚
*   **æœºåˆ¶**: 
    1.  èŠ‚ç‚¹è¿è¡Œå‰è®¡ç®— CacheKeyã€‚
    2.  æ£€æŸ¥ç£ç›˜æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ Parquet/Pickle æ–‡ä»¶ã€‚
    3.  è‹¥å‘½ä¸­ï¼Œè·³è¿‡è®¡ç®—ï¼Œç›´æ¥åŠ è½½ç¼“å­˜æ–‡ä»¶ã€‚
*   **UI åé¦ˆ**: ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹æ˜¾ç¤º ğŸŸ¢ (Cached) æˆ– ğŸ”µ (Running)ã€‚

### 4.3 å¤åˆèŠ‚ç‚¹ (Sub-Graph)

åº”å¯¹å¤æ‚ç­–ç•¥çš„å¯è§†åŒ–ç®¡ç†ã€‚

*   **Group**: ä»…è§†è§‰åˆ†ç»„ï¼Œæ”¯æŒæŠ˜å /å±•å¼€ã€‚
*   **Pack**: å°†é€‰ä¸­çš„å­å›¾æ‰“åŒ…æˆä¸€ä¸ªæ–°çš„â€œè‡ªå®šä¹‰èŠ‚ç‚¹â€ï¼Œå¯¹å¤–æš´éœ²ç‰¹å®šçš„ Input/Output ç«¯å£ï¼Œæ”¯æŒåœ¨å…¶ä»–å·¥ä½œæµä¸­å¤ç”¨ã€‚

---

## äº”ã€åè®®æ ‡å‡† (Protocols) **[New]**

### 5.1 æ ‡å‡†ä¿¡å·åè®® (Standard Signal Protocol)

ä¸ºäº†ç¡®ä¿ç­–ç•¥èŠ‚ç‚¹ä¸å›æµ‹/äº¤æ˜“èŠ‚ç‚¹çš„äº’é€šæ€§ï¼Œå¿…é¡»å®šä¹‰ä¸¥æ ¼çš„ä¿¡å·ç»“æ„ã€‚

```typescript
interface SignalItem {
  timestamp: string;      // ä¿¡å·äº§ç”Ÿæ—¶é—´ (ISO8601)
  asset_id: string;       // æ ‡çš„ä»£ç  (e.g., "000001.SZ")
  
  // æ ¸å¿ƒåŠ¨ä½œ
  action: 'OPEN_LONG' | 'OPEN_SHORT' | 'CLOSE_LONG' | 'CLOSE_SHORT' | 'ADJUST_TARGET';
  
  // æ‰§è¡Œå‚æ•°
  target_weight?: number; // ç›®æ ‡ä»“ä½æƒé‡ (0.0 - 1.0)
  target_volume?: number; // ç›®æ ‡æˆäº¤é‡
  limit_price?: number;   // é™ä»·å•ä»·æ ¼
  
  // å½’å› ä¸å…ƒæ•°æ®
  strategy_id: string;    // ç­–ç•¥ID
  score?: number;         // ä¿¡å·å¼ºåº¦/ç½®ä¿¡åº¦
  metadata?: Record<string, any>; // æ‰©å±•å­—æ®µ (e.g., {"ma_diff": 0.5})
}
```

### 5.2 é™æ€åˆ†æ (Static Analysis)

åœ¨â€œç¼–ç æ—¶â€è€Œéâ€œè¿è¡Œæ—¶â€å‘ç°é”™è¯¯ã€‚

*   **å¼•ç”¨æ£€æŸ¥**: å½“èŠ‚ç‚¹å‚æ•°å¼•ç”¨äº†ä¸Šæ¸¸çš„ `close` åˆ—ï¼Œè€Œä¸Šæ¸¸èŠ‚ç‚¹è¢«ä¿®æ”¹å¯¼è‡´ä¸å†è¾“å‡º `close` åˆ—æ—¶ï¼ŒUI ç«‹å³å°†è¯¥å‚æ•°æ ‡çº¢ï¼Œå¹¶æç¤º "Invalid Column Reference"ã€‚
*   **ç±»å‹æ£€æŸ¥**: å½“è¾“å…¥ç±»å‹ä¸åŒ¹é…ä¸”æ— æ³•è‡ªåŠ¨è½¬æ¢æ—¶ï¼Œè¿çº¿å˜ä¸ºçº¢è‰²è™šçº¿ã€‚

---

## å…­ã€èŠ‚ç‚¹å®šä¹‰è§„èŒƒ (Node Spec)

### 6.1 èŠ‚ç‚¹æ•°æ®ç»“æ„

```typescript
interface WorkflowNodeDefinition {
  id: string;             // å”¯ä¸€æ ‡è¯† (e.g., "ma_calc")
  version: string;        // ç‰ˆæœ¬å· (e.g., "1.0.2")
  
  // å…ƒæ•°æ®
  meta: {
    category: NodeCategory; // åˆ†ç±»
    label: string;          // æ˜¾ç¤ºå
    icon: string;           // å›¾æ ‡
    description: string;
    tags?: string[];
  };

  // ç«¯å£å®šä¹‰
  inputs: InputPortDef[];
  outputs: OutputPortDef[];

  // å‚æ•°è¡¨å• Schema (é©±åŠ¨ UI æ¸²æŸ“)
  parameters: ParameterDef[];
}
```

### 6.2 åŠ¨æ€ Schema æ¨å¯¼ (Dynamic Schema Discovery)

å¯¹äº `Code Block` æˆ– `API Fetcher` è¿™ç±»â€œé»‘ç›’â€èŠ‚ç‚¹ï¼Œæ— æ³•é™æ€é¢„çŸ¥è¾“å‡ºåˆ—ã€‚

**è§£å†³æ–¹æ¡ˆï¼šDry Run (è¯•è¿è¡Œ)**

1.  **äº¤äº’**: ç”¨æˆ·åœ¨é…ç½®é¢æ¿ç‚¹å‡» **[ğŸ” æ¢æµ‹è¾“å‡ºç»“æ„]** æŒ‰é’®ã€‚
2.  **åç«¯**: 
    *   å¦‚æœæ˜¯ API/Fileï¼šè¯»å–å‰ N è¡Œ (Sample)ã€‚
    *   å¦‚æœæ˜¯ Codeï¼šä½¿ç”¨ Mock è¾“å…¥è¿è¡Œä»£ç ï¼Œæ•è·è¾“å‡º DataFrame çš„ `dtypes`ã€‚
3.  **åé¦ˆ**: åç«¯è¿”å› `ColumnDefinition[]`ï¼Œå‰ç«¯è‡ªåŠ¨å¡«å……åˆ°èŠ‚ç‚¹çš„ Output Schema é…ç½®ä¸­å¹¶æŒä¹…åŒ–ã€‚

---

## ä¸ƒã€å‚æ•°ç±»å‹ç³»ç»Ÿ (Parameter DSL)

é‡‡ç”¨ **Type + Config** æ¨¡å¼ï¼Œå®ç°é«˜åº¦å¯æ‰©å±•çš„å‚æ•°ç¼–è¾‘å™¨ã€‚

### 7.1 åŸºç¡€å€¼ç±»å‹

| ç±»å‹ | UI ç»„ä»¶ | è¿”å›ç±»å‹ | Config ç¤ºä¾‹ |
|:---|:---|:---|:---|
| `text` | Input | string | `{ placeholder: "prefix_" }` |
| `number` | InputNumber | number | `{ min: 0, max: 100, step: 0.1 }` |
| `boolean` | Switch | boolean | `{ activeText: "å¼€å¯", inactiveText: "å…³é—­" }` |
| `select` | Select | string | `{ options: [{label:"A", value:"a"}] }` |
| `code` | MonacoEditor | string | `{ language: "python", height: "300px" }` |

### 7.2 ä¸šåŠ¡ä¸“ç”¨ç±»å‹ (Business Types)

#### 7.2.1 `file_picker` (æ–‡ä»¶é€‰æ‹©å™¨)
*   **ç”¨é€”**: é€‰æ‹©æœåŠ¡å™¨ç«¯æ–‡ä»¶/ç›®å½•ã€‚
*   **Config**:
    *   `mode`: "file" | "folder"
    *   `extensions`: [".csv", ".parquet"]
    *   `root_path`: "/data/quant/" (é™åˆ¶è®¿é—®èŒƒå›´)

#### 7.2.2 `column_picker` (åˆ—é€‰æ‹©å™¨)
*   **ç”¨é€”**: ä»ä¸Šæ¸¸ Schema ä¸­é€‰æ‹©åˆ—ã€‚
*   **Config**:
    *   `mode`: "single" | "multiple"
    *   `filter_type`: ["number"] (ä»…å…è®¸é€‰æ‹©æ•°å€¼åˆ—)
    *   `include_system`: false (æ˜¯å¦åŒ…å« `_id` ç­‰ç³»ç»Ÿåˆ—)

#### 7.2.3 `table_selector` (æ•°æ®åº“è¡¨é€‰æ‹©)
*   **ç”¨é€”**: é€‰æ‹©æ•°æ®åº“è¡¨ï¼Œæ”¯æŒè‡ªåŠ¨è”æƒ³ã€‚
*   **Config**:
    *   `connection_id`: å…³è”çš„æ•°æ®åº“è¿æ¥å‚æ•°å
    *   `schema_filter`: "public"

---

## å…«ã€UI/UX äº¤äº’è®¾è®¡

### 8.1 èŠ‚ç‚¹é…ç½®é¢æ¿ (Config Panel)

é¢æ¿åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼š

1.  **Inputs (ä¸Šæ¸¸æ˜ å°„)**:
    *   æ˜¾ç¤ºå½“å‰è¿æ¥çš„ä¸Šæ¸¸èŠ‚ç‚¹ã€‚
    *   **Schema Preview**: æ‚¬æµ®æ˜¾ç¤ºä¸Šæ¸¸ä¼ å…¥çš„åˆ—åˆ—è¡¨ã€‚
2.  **Parameters (å‚æ•°é…ç½®)**:
    *   æ ¹æ® `parameters` å®šä¹‰åŠ¨æ€æ¸²æŸ“è¡¨å•ã€‚
    *   æ”¯æŒ**ä¾èµ–æ˜¾ç¤º (Conditional Visibility)**: ä¾‹å¦‚å½“ `enable_filter` ä¸º true æ—¶æ‰æ˜¾ç¤º `filter_expression`ã€‚
3.  **Outputs (è¾“å‡ºå®šä¹‰)**:
    *   **é€ä¼ æ§åˆ¶**: [å…¨é€‰] [åé€‰] ä¸Šæ¸¸åˆ—ã€‚
    *   **æ–°å¢åˆ—å®šä¹‰**: æ‰‹åŠ¨æˆ–é€šè¿‡ [æ¢æµ‹] æŒ‰é’®æ·»åŠ æ–°ç”Ÿæˆçš„åˆ—ã€‚

### 8.2 æ•°æ®è°ƒè¯•ä¸é¢„è§ˆ (Data Debugging)

åœ¨ç”»å¸ƒä¸Šæä¾›å¼ºå¤§çš„è°ƒè¯•èƒ½åŠ›ï¼š

*   **ç«¯å£é¢„è§ˆ (Port Peek)**:
    *   é¼ æ ‡æ‚¬åœåœ¨èŠ‚ç‚¹ Output ç«¯å£ä¸Š 1ç§’ã€‚
    *   å¼¹å‡º Popoverï¼Œæ˜¾ç¤ºè¯¥ç«¯å£æœ€è¿‘ä¸€æ¬¡è¿è¡Œçš„ **Data Snapshot (å‰ 5 è¡Œ)**ã€‚
    *   åŒ…å«åˆ—åã€æ•°æ®ç±»å‹å’Œéƒ¨åˆ†å€¼ã€‚
*   **æ‰§è¡Œè¿›åº¦æ¡**: 
    *   èŠ‚ç‚¹é¡¶éƒ¨æ˜¾ç¤ºè¿›åº¦æ¡ (Progress Bar)ï¼Œå±•ç¤ºå¤„ç†è¿›åº¦ (é’ˆå¯¹é•¿è€—æ—¶ä»»åŠ¡)ã€‚

---

## ä¹ã€åç«¯ API è§„èŒƒ

### 9.1 èŠ‚ç‚¹æ³¨å†Œè¡¨

```http
GET /api/v1/nodes/registry
Response:
{
  "categories": ["Input", "Transform", "Quant", "Output"],
  "nodes": [
    {
      "id": "csv_loader",
      "version": "1.0.0",
      "meta": { ... },
      "parameters": [ ... ]
    },
    ...
  ]
}
```

### 9.2 Schema æ¢æµ‹

```http
POST /api/v1/nodes/inspect-schema
Request:
{
  "node_type": "csv_loader",
  "params": {
    "path": "/data/daily/2025.csv",
    "encoding": "utf-8"
  }
}
Response:
{
  "status": "success",
  "columns": [
    { "name": "date", "type": "date" },
    { "name": "close", "type": "number" }
  ]
}
```

### 9.3 å·¥ä½œæµæ‰§è¡Œ (Dry Run)

```http
POST /api/v1/workflow/dry-run
Request:
{
  "target_node_id": "node_3", // ä»…è¿è¡Œåˆ°æ­¤èŠ‚ç‚¹
  "graph": { ... }
}
```

---

## åã€å®æ–½è·¯çº¿å›¾ (Implementation Roadmap)

1.  **Phase 1: Core Type Definitions**
    *   å»ºç«‹ `types/workflow.ts`ï¼Œä¸¥æ ¼å®šä¹‰ Node, Edge, Port, Schema æ¥å£ã€‚
2.  **Phase 2: Node Registry Backend**
    *   å®ç° Python ç«¯çš„èŠ‚ç‚¹æ‰«æä¸æ³¨å†Œæœºåˆ¶ (`@register_node` è£…é¥°å™¨)ã€‚
3.  **Phase 3: Frontend Schema Propagation**
    *   åœ¨ ReactFlow ä¸­å®ç° DAG éå†ç®—æ³•ï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ `availableColumns`ã€‚
4.  **Phase 4: Dynamic Form Engine**
    *   å¼€å‘åŸºäº JSON Schema çš„å‚æ•°è¡¨å•æ¸²æŸ“å™¨ã€‚
5.  **Phase 5: Global Context & Signal**
    *   å®ç°å˜é‡æ›¿æ¢é€»è¾‘å’Œä¿¡å·æ ‡å‡†åŒ–ã€‚

---
