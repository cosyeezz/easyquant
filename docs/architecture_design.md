# EasyQuant æ¶æ„è®¾è®¡æ–¹æ¡ˆï¼šåŸºäºå·¥ä½œæµçš„ç¼–æ’ç³»ç»Ÿ

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

æœ¬æ¶æ„æ–¹æ¡ˆæ—¨åœ¨é€šè¿‡**â€œå·¥ä½œæµåµŒå¥—â€**ä¸**â€œæ§åˆ¶æµèŠ‚ç‚¹åŒ–â€**çš„è®¾è®¡ï¼Œæ„å»ºä¸€ä¸ªé«˜å†…èšã€ä½è€¦åˆä¸”å…·å¤‡é«˜æ€§èƒ½æ‰©å±•èƒ½åŠ›çš„é‡åŒ–ç¼–æ’ç³»ç»Ÿã€‚

*   **ä¸€åˆ‡çš†èŠ‚ç‚¹ (Everything is a Node)**: æ— è®ºæ˜¯ç®€å•çš„æ•°æ®æ¸…æ´—ï¼Œè¿˜æ˜¯å¤æ‚çš„å¤šè¿›ç¨‹è°ƒåº¦ï¼Œçš†è¡¨ç°ä¸ºå›¾ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚
*   **å·¥ä½œæµå³å‡½æ•° (Workflow as a Function)**: ä¸€ä¸ªå®šä¹‰å¥½çš„å·¥ä½œæµå¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªå…·å¤‡è¾“å…¥ï¼ˆå‚æ•°ï¼‰å’Œè¾“å‡ºï¼ˆç»“æœï¼‰çš„â€œå‡½æ•°â€ï¼Œå¯ä»¥è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨ã€‚
*   **Runner æç®€åŒ– (Minimalist Runner)**: æ‰§è¡Œå¼•æ“ä¿æŒå•ä¸€èŒè´£ï¼ˆæ‹“æ‰‘æ’åº+é¡ºåºæ‰§è¡Œï¼‰ï¼Œå¹¶å‘ã€å¾ªç¯ã€ç›‘å¬ç­‰å¤æ‚é€»è¾‘ä¸‹æ²‰åˆ°å…·ä½“çš„â€œè°ƒåº¦å™¨èŠ‚ç‚¹â€å†…éƒ¨å®ç°ã€‚

---

## 2. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 2.1 å®ä½“æ¨¡å‹

1.  **èŠ‚ç‚¹ (Node)**
    *   **å®šä¹‰ (Definition)**: åŒ…å«å…ƒæ•°æ®ï¼ˆåç§°ã€å›¾æ ‡ï¼‰ã€å‚æ•° Schemaã€ä»£ç è·¯å¾„ (`handler_path`)ã€‚
    *   **å®ä¾‹ (Instance)**: è¿è¡Œæ—¶çš„å®ä½“ï¼Œæºå¸¦å…·ä½“å‚æ•°é…ç½®ã€‚
    *   **èŒè´£**: æ‰§è¡Œå…·ä½“çš„åŸå­æ“ä½œï¼ˆå¦‚ `pandas.read_csv`, `process_pool.submit`ï¼‰ã€‚

2.  **å·¥ä½œæµ (Workflow)**
    *   ç”±èŠ‚ç‚¹å’Œè¿çº¿ç»„æˆçš„æœ‰å‘æ— ç¯å›¾ (DAG)ã€‚
    *   **ç‹¬ç«‹æ€§**: æ¯ä¸ªå·¥ä½œæµéƒ½æœ‰ç‹¬ç«‹çš„ ID å’Œç‰ˆæœ¬ï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œã€æµ‹è¯•ã€‚
    *   **å¯å¤ç”¨æ€§**: å·¥ä½œæµ A å¯ä»¥ä½œä¸ºå·¥ä½œæµ B ä¸­â€œå­å·¥ä½œæµèŠ‚ç‚¹â€çš„å‚æ•°ã€‚

3.  **æ‰§è¡Œå¼•æ“ (Runner)**
    *   **æ ¸å¿ƒé€»è¾‘**: æ¥æ”¶ Graph JSON -> æ‹“æ‰‘æ’åº -> ä¾æ¬¡å®ä¾‹åŒ– Handler -> æ‰§è¡Œ `run()` -> ä¼ é€’ Contextã€‚
    *   **ç‰¹æ€§**: é»˜è®¤æ˜¯**å•è¿›ç¨‹ã€åŒæ­¥**çš„ã€‚å®ƒä¸å…³å¿ƒå¹¶å‘ï¼Œåªå…³å¿ƒå½“å‰å›¾çš„æ‰§è¡Œå®Œæ¯•ã€‚

### 2.2 æ ¸å¿ƒæ¨¡å¼ï¼šè°ƒåº¦å™¨èŠ‚ç‚¹ (Scheduler Node)

è¿™æ˜¯è§£å†³é«˜æ€§èƒ½ä¸å¹¶å‘é—®é¢˜çš„å…³é”®ã€‚æˆ‘ä»¬ä¸å†ä¿®æ”¹ Runner æ¥æ”¯æŒå¤šè¿›ç¨‹ï¼Œè€Œæ˜¯å®ç°ä¸€ç§ç‰¹æ®Šçš„èŠ‚ç‚¹ã€‚

*   **è¾“å…¥**:
    *   `target_workflow_id`: è¦è°ƒç”¨çš„å­å·¥ä½œæµã€‚
    *   `concurrency`: å¹¶å‘æ•°ï¼ˆè¿›ç¨‹/çº¿ç¨‹æ•°ï¼‰ã€‚
    *   `iterable_inputs`: å¾…å¤„ç†çš„æ•°æ®åˆ—è¡¨ï¼ˆå¦‚è‚¡ç¥¨ä»£ç  listã€å‚æ•° listï¼‰ã€‚
*   **æ‰§è¡Œé€»è¾‘**:
    1.  èŠ‚ç‚¹å†…éƒ¨å¯åŠ¨ `ProcessPoolExecutor`ã€‚
    2.  å°† `iterable_inputs` æ‹†è§£ä¸ºå¤šä¸ªä»»åŠ¡ã€‚
    3.  æ¯ä¸ªä»»åŠ¡å¯åŠ¨ä¸€ä¸ªæ–°çš„ Runner å®ä¾‹ï¼ˆåœ¨å­è¿›ç¨‹ä¸­ï¼‰ã€‚
    4.  åŠ è½½ `target_workflow_id` çš„å›¾å®šä¹‰å¹¶æ‰§è¡Œã€‚
    5.  æ”¶é›†æ‰€æœ‰å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œä½œä¸ºè¯¥èŠ‚ç‚¹çš„è¾“å‡ºã€‚

---

## 3. å…³é”®åœºæ™¯å®ç°æ–¹æ¡ˆ

### 3.1 åœºæ™¯ä¸€ï¼šå¤šè¿›ç¨‹æµ·é‡æ•°æ® ETL (IO å¯†é›†å‹)

**éœ€æ±‚**: æ¯æ—¥ä¸‹è½½ 5000 åªè‚¡ç¥¨çš„æ—¥çº¿æ•°æ®å¹¶å†™å…¥æ•°æ®åº“ã€‚

*   **å­å·¥ä½œæµ (Child - "DownloadStock")**:
    *   `[è¾“å…¥å˜é‡: stock_code]` -> `[ç½‘ç»œè¯·æ±‚èŠ‚ç‚¹]` -> `[æ•°æ®æ¸…æ´—èŠ‚ç‚¹]` -> `[DBå†™å…¥èŠ‚ç‚¹]`
    *   *æ³¨: æ­¤å·¥ä½œæµåŒ…å«å®Œæ•´çš„ DB è¿æ¥åˆå§‹åŒ–é€»è¾‘ã€‚*
*   **çˆ¶å·¥ä½œæµ (Parent)**:
    1.  `[è·å–å…¨å¸‚åœºä»£ç èŠ‚ç‚¹]`: è¾“å‡º `['000001', '000002', ...]`ã€‚
    2.  `[å¤šè¿›ç¨‹è°ƒåº¦èŠ‚ç‚¹ (BatchScheduler)]`:
        *   å¼•ç”¨: "DownloadStock"
        *   è¾“å…¥: ä¸Šä¸€æ­¥çš„ä»£ç åˆ—è¡¨
        *   å¹¶å‘: 8 (CPUæ ¸æ•°)
*   **æ‰§è¡Œæµ**: çˆ¶å·¥ä½œæµè¿è¡Œä¸€æ¬¡ -> è°ƒåº¦èŠ‚ç‚¹åˆ†è£‚å‡º 5000 ä¸ªä»»åŠ¡ -> 8 ä¸ªè¿›ç¨‹å¹¶è¡Œæ¶ˆåŒ– -> æ¯ä¸ªå­è¿›ç¨‹ç‹¬ç«‹åˆ›å»º DB è¿æ¥ -> å®Œæˆã€‚

### 3.2 åœºæ™¯äºŒï¼šé«˜æ€§èƒ½å‚æ•°éå†å›æµ‹ (CPU å¯†é›†å‹)

**éœ€æ±‚**: é’ˆå¯¹ç­–ç•¥æµ‹è¯• MA=5, 10, 20... ç­‰ 100 ç§å‚æ•°ç»„åˆçš„æ•ˆæœã€‚

*   **å­å·¥ä½œæµ (Child - "BacktestStrategy")**:
    *   `[è¾“å…¥å˜é‡: ma_window]` -> `[è¯»å–ä¸­é—´æ•°æ®èŠ‚ç‚¹]` -> `[ç­–ç•¥å›æµ‹èŠ‚ç‚¹]` -> `[è¿”å›æŒ‡æ ‡]`
*   **çˆ¶å·¥ä½œæµ (Parent)**:
    1.  `[æ•°æ®é¢„åŠ è½½èŠ‚ç‚¹]`: è¯»å–æ•°æ®åº“ï¼Œä¿å­˜ä¸º Parquet/Feather æ–‡ä»¶ï¼ˆæˆ–å†™å…¥ Shared Memoryï¼‰ï¼Œè¾“å‡º `file_path`ã€‚
    2.  `[å‚æ•°ç”ŸæˆèŠ‚ç‚¹]`: ç”Ÿæˆ `[{ma:5}, {ma:10}, ...]`ã€‚
    3.  `[å¤šè¿›ç¨‹è°ƒåº¦èŠ‚ç‚¹]`:
        *   å¼•ç”¨: "BacktestStrategy"
        *   å…¬å…±å‚æ•°: `file_path` (é¿å…å­è¿›ç¨‹é‡å¤è¯»åº“)
        *   è¿­ä»£å‚æ•°: å‚æ•°åˆ—è¡¨
*   **ä¼˜åŠ¿**: å­è¿›ç¨‹é€šè¿‡æ–‡ä»¶/å…±äº«å†…å­˜è¯»å–æ•°æ®ï¼Œæå¤§é™ä½å†…å­˜å¼€é”€å’Œ DB å‹åŠ›ã€‚

### 3.3 åœºæ™¯ä¸‰ï¼šå®ç›˜/äº‹ä»¶é©±åŠ¨ (ä½å»¶è¿Ÿ)

**éœ€æ±‚**: ç›‘å¬ WebSocket è¡Œæƒ…ï¼Œè§¦å‘ç­–ç•¥è®¡ç®—ã€‚

*   **å­å·¥ä½œæµ (Child - "OnTick")**:
    *   `[è¾“å…¥å˜é‡: tick_data]` -> `[æŠ€æœ¯æŒ‡æ ‡è®¡ç®—]` -> `[ä¸‹å•åˆ¤æ–­]` -> `[äº¤æ˜“æ¥å£]`
*   **å®ç›˜å®ˆæŠ¤è¿›ç¨‹ (Main Process)**:
    *   è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„**â€œç›‘å¬èŠ‚ç‚¹ (Listener Node)â€** (æˆ–ç‹¬ç«‹çš„å®ˆæŠ¤è„šæœ¬)ã€‚
    *   å®ƒä¸ç»“æŸï¼Œè€Œæ˜¯ç»´æŠ¤ WebSocket è¿æ¥ã€‚
    *   æ¯æ”¶åˆ° Tickï¼Œå®ƒ**å¼‚æ­¥è°ƒç”¨** Runner æ‰§è¡Œ "OnTick" å·¥ä½œæµã€‚
    *   *ä¼˜åŒ–*: å¯¹äºæä½å»¶è¿Ÿéœ€æ±‚ï¼ŒListener Node å¯ä»¥ç›´æ¥å†…åµŒç­–ç•¥é€»è¾‘ï¼Œæˆ–ä¿æŒ Runner å®ä¾‹å¸¸é©»ï¼ˆContext ä¿æŒï¼‰ä»¥é¿å…åˆå§‹åŒ–å¼€é”€ã€‚

---

## 4. é«˜æ€§èƒ½æ‰§è¡Œç­–ç•¥ (Performance Strategy)

ä¸ºäº†åœ¨ Python ç¯å¢ƒä¸‹å‹æ¦¨ç³»ç»Ÿæ€§èƒ½ï¼Œæœ¬æ¶æ„é‡‡ç”¨â€œå®è§‚å¤šè¿›ç¨‹ + å¾®è§‚å¤šçº¿ç¨‹â€çš„æ··åˆå¹¶å‘æ¨¡å‹ã€‚

### 4.1 å®è§‚å¹¶å‘ï¼šä»»åŠ¡çº§å¤šè¿›ç¨‹ (Macro-Concurrency)
*   **å®ç°**: é€šè¿‡â€œå¤šè¿›ç¨‹è°ƒåº¦èŠ‚ç‚¹â€è°ƒç”¨ `ProcessPoolExecutor`ã€‚
*   **ç›®çš„**: åˆ©ç”¨å¤šæ ¸ CPU å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚å›æµ‹é€»è¾‘ã€æ•°æ®æ¸…æ´—ï¼‰ï¼Œå¹¶å®ç°æ•°æ®åº“è¿æ¥æ± ç­‰ç‰©ç†èµ„æºçš„å½»åº•éš”ç¦»ã€‚
*   **é€‚ç”¨**: æ‰¹é‡ä»»åŠ¡åˆ†å‘ã€å‚æ•°æœç´¢ã€‚

### 4.2 å¾®è§‚å¹¶å‘ï¼šèŠ‚ç‚¹å†…å¤šçº¿ç¨‹ (Micro-Concurrency)
*   **å®ç°**: åœ¨ IO å¯†é›†å‹èŠ‚ç‚¹çš„ Handler å†…éƒ¨è°ƒç”¨ `ThreadPoolExecutor`ã€‚
*   **ç›®çš„**: æ©ç›– I/O ç­‰å¾…æ—¶é—´ã€‚ç”±äº Python åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼ˆè¯»å†™æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ï¼‰æ—¶ä¼šé‡Šæ”¾ GILï¼Œå¤šçº¿ç¨‹èƒ½æ˜¾è‘—æå‡æ•°æ®ååé‡ã€‚
*   **é€‚ç”¨**: æ‰¹é‡è¯»å– CSV/Parquet æ–‡ä»¶ã€å¹¶å‘è¯·æ±‚ HTTP APIã€å¤§æ‰¹é‡æ•°æ®å…¥åº“ã€‚

### 4.3 è°ƒåº¦åŸåˆ™ï¼šåŒæ­¥ Runner
*   æ‰§è¡Œå¼•æ“ (Runner) ä¿æŒ**åŒæ­¥é¡ºåºæ‰§è¡Œ**æ¨¡å¼ã€‚
*   Runner ä¸è´Ÿè´£ä»»ä½•å¤æ‚çš„å¹¶å‘è°ƒåº¦ï¼Œæ‰€æœ‰çš„å¹¶å‘é€»è¾‘å‡å°è£…åœ¨å…·ä½“çš„ Handler å†…éƒ¨ï¼ˆå¯¹å¤–é€æ˜ï¼‰ã€‚
*   è¿™ç§æ¨¡å¼æå¤§åœ°é™ä½äº†å·¥ä½œæµçš„è°ƒè¯•éš¾åº¦ï¼Œä½¿æ‰§è¡Œè½¨è¿¹æ¸…æ™°ã€å¯é¢„æµ‹ã€‚

---

## 5. èµ„æºä¸çŠ¶æ€ç®¡ç†

### 5.1 æ•°æ®åº“è¿æ¥æ±  (DB Connection Pool)
*   **åŸåˆ™**: **è¿›ç¨‹éš”ç¦»ï¼Œç”¨åå³ç„šï¼ˆæˆ–å¤ç”¨ï¼‰**ã€‚
*   **çˆ¶å·¥ä½œæµ**: ä¸»è¿›ç¨‹ Runner åˆå§‹åŒ–è‡ªå·±çš„ DB Contextã€‚
*   **å­å·¥ä½œæµ**: è°ƒåº¦å™¨åœ¨æ–°è¿›ç¨‹å¯åŠ¨ Runner -> æ–° Runner åˆå§‹åŒ–è‡ªå·±çš„ DB Contextã€‚
*   **ç»“æœ**: å¤©ç„¶é¿å¼€äº†â€œè¿›ç¨‹é—´ä¼ é€’è¿æ¥æ± â€çš„æ­»é”é—®é¢˜ã€‚æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤è‡ªå·±çš„å°è¿æ¥æ± ã€‚

### 4.2 çŠ¶æ€ä¼ é€’
*   **çˆ¶ -> å­**: é€šè¿‡ JSON å¯åºåˆ—åŒ–çš„å‚æ•°ä¼ é€’ï¼ˆConfig, Variablesï¼‰ã€‚
*   **å­ -> çˆ¶**: å­ Runner è¿”å›æ‰§è¡Œç»“æœï¼ˆJSON/Dictï¼‰ï¼Œè°ƒåº¦å™¨èŠ‚ç‚¹æ±‡æ€»æˆåˆ—è¡¨ã€‚

---

## 5. æ–¹æ¡ˆæ€»ç»“

| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹æ¡ˆ (Monolithic Runner) | æœ¬æ–¹æ¡ˆ (Workflow Centric) |
| :--- | :--- | :--- |
| **å¤æ‚åº¦** | é«˜ (Runner éœ€å¤„ç†å¹¶å‘/åˆ†ç‰‡) | **ä½** (Runner ä»…è´Ÿè´£å•æ¬¡æ‰§è¡Œ) |
| **æ‰©å±•æ€§** | å·® (æ–°å¢å¹¶å‘æ¨¡å¼éœ€æ”¹å†…æ ¸) | **é«˜** (æ–°å¢å¹¶å‘æ¨¡å¼åªéœ€åŠ èŠ‚ç‚¹) |
| **å¤ç”¨æ€§** | ä»£ç çº§å¤ç”¨ | **é€»è¾‘çº§å¤ç”¨ (å­å·¥ä½œæµ)** |
| **è°ƒè¯•** | å›°éš¾ (å¹¶å‘éš¾ä»¥ Debug) | **ç®€å•** (å­å·¥ä½œæµå¯ç‹¬ç«‹è°ƒè¯•) |

æœ¬æ–¹æ¡ˆé€šè¿‡**ç»„åˆ**è€Œé**ç¡¬ç¼–ç **çš„æ–¹å¼è§£å†³å¤æ‚æ€§ï¼Œå®Œç¾å¥‘åˆ EasyQuant å¯è§†åŒ–ã€æ¨¡å—åŒ–çš„äº§å“æ„¿æ™¯ã€‚

---

## 6. è¿›ç¨‹è°ƒåº¦èŠ‚ç‚¹è¯¦ç»†è®¾è®¡ (ProcessSchedulerNode)

### 6.1 è®¾è®¡ç›®æ ‡

è¿›ç¨‹è°ƒåº¦èŠ‚ç‚¹æ˜¯ç³»ç»Ÿä¸­**å”¯ä¸€å…è®¸å¯åŠ¨å¤šè¿›ç¨‹**çš„åœ°æ–¹ï¼Œå®ƒä¸æ˜¯å·¥ä½œæµå†…éƒ¨çš„æ™®é€šèŠ‚ç‚¹ï¼Œè€Œæ˜¯**åŒ…è£¹æ•´ä¸ªå·¥ä½œæµ**çš„è°ƒåº¦å®¹å™¨ã€‚

æ ¸å¿ƒç›®æ ‡ï¼š
- **å¯è§†åŒ–ç¼–æ’**ï¼šç”¨æˆ·å¯åœ¨ UI ä¸­ç›´è§‚é…ç½®ç”Ÿäº§è€…/æ¶ˆè´¹è€…è¿›ç¨‹
- **è§£è€¦è¿›ç¨‹é—´é€šä¿¡**ï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å®ç°è¿›ç¨‹é—´æ•°æ®ä¼ é€’
- **å¼¹æ€§æ‰©ç¼©å®¹**ï¼šè¿›ç¨‹æ•°ã€çº¿ç¨‹æ•°å¯ç‹¬ç«‹é…ç½®
- **æµå¼å¤„ç†**ï¼šé¿å…å†…å­˜æº¢å‡ºï¼Œæ”¯æŒå¤§æ•°æ®é‡

### 6.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ProcessSchedulerNode (å¯è§†åŒ–ç¼–è¾‘å™¨)                  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ è¿›ç¨‹ç»„ A: æ•°æ®è¯»å– (Ã—2)   â”‚          â”‚ è¿›ç¨‹ç»„ B: æ•°æ®å¤„ç† (Ã—1)   â”‚      â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
â”‚  â”‚ â”‚ CsvLoaderNode         â”‚ â”‚          â”‚ â”‚ MQConsumerNode        â”‚ â”‚      â”‚
â”‚  â”‚ â”‚ â”œâ”€ path: /data/stocks â”‚ â”‚          â”‚ â”‚ â”œâ”€ topic: raw_data    â”‚ â”‚      â”‚
â”‚  â”‚ â”‚ â””â”€ threads: 4         â”‚ â”‚          â”‚ â”‚ â””â”€ group: processor   â”‚ â”‚      â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
â”‚  â”‚             â†“             â”‚          â”‚             â†“             â”‚      â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
â”‚  â”‚ â”‚ MQProducerNode        â”‚ â”‚          â”‚ â”‚ FactorCalcNode        â”‚ â”‚      â”‚
â”‚  â”‚ â”‚ â””â”€ topic: raw_data    â”‚ â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚             â†“             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
â”‚         Ã— 2 ä¸ªè¿›ç¨‹å®ä¾‹                   â”‚ â”‚ DbSaveNode            â”‚ â”‚      â”‚
â”‚                                         â”‚ â”‚ â””â”€ table: stock_data  â”‚ â”‚      â”‚
â”‚                                         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                Ã— 1 ä¸ªè¿›ç¨‹å®ä¾‹               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         Message Queue           â”‚
                    â”‚  (Redis Streams / RocketMQ)     â”‚
                    â”‚                                 â”‚
                    â”‚  topic: raw_data                â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”     â”‚
                    â”‚  â”‚msg1 â”‚msg2 â”‚msg3 â”‚ ... â”‚     â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 æ•°æ®æµæ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®æµå‘                                        â”‚
â”‚                                                                             â”‚
â”‚  [CsvLoaderè¿›ç¨‹1] â”€â”€â”                                                       â”‚
â”‚         â†“          â”‚                                                       â”‚
â”‚    è¯»å– chunk      â”œâ”€â”€â–º [MQ: raw_data] â”€â”€â”¬â”€â”€â–º [å¤„ç†è¿›ç¨‹] â”€â”€â–º [DB]          â”‚
â”‚         â†“          â”‚                     â”‚                                 â”‚
â”‚  [CsvLoaderè¿›ç¨‹2] â”€â”€â”˜                     â”‚                                 â”‚
â”‚         â†“                                â”‚                                 â”‚
â”‚    è¯»å– chunk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                             â”‚
â”‚  ç‰¹ç‚¹ï¼š                                                                      â”‚
â”‚  â”œâ”€ ç”Ÿäº§è€…å¹¶è¡Œè¯»å–ï¼Œäº’ä¸é˜»å¡                                                  â”‚
â”‚  â”œâ”€ æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ï¼Œè‡ªåŠ¨èƒŒå‹                                                    â”‚
â”‚  â”œâ”€ æ¶ˆè´¹è€…æŒ‰éœ€æ‰©å±•                                                           â”‚
â”‚  â””â”€ å¤§æ•°æ®åœ¨è¿›ç¨‹å†…æµè½¬ï¼Œè·¨è¿›ç¨‹åªä¼ åºåˆ—åŒ– chunk                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 UI äº¤äº’è®¾è®¡

#### 6.4.1 è¿›ç¨‹è°ƒåº¦èŠ‚ç‚¹ç¼–è¾‘å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProcessScheduler: è‚¡ç¥¨æ•°æ®ETL                              [ä¿å­˜] [è¿è¡Œ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¿›ç¨‹ç»„åˆ—è¡¨                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ ğŸ“¦ æ•°æ®è¯»å–ç»„                                    [å¤åˆ¶] [åˆ é™¤]  â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â”œâ”€ è¿›ç¨‹æ•°: [2]  çº¿ç¨‹æ•°: [4]                                     â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â””â”€ è¾“å‡ºé˜Ÿåˆ—: raw_data                                           â”‚ â”‚   â”‚
â”‚  â”‚ â”‚                                                 [ç¼–è¾‘å·¥ä½œæµ â†’]  â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ ğŸ“¦ æ•°æ®å¤„ç†ç»„                                    [å¤åˆ¶] [åˆ é™¤]  â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â”œâ”€ è¿›ç¨‹æ•°: [1]  çº¿ç¨‹æ•°: [1]                                     â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â”œâ”€ è¾“å…¥é˜Ÿåˆ—: raw_data                                           â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â””â”€ è¾“å‡ºé˜Ÿåˆ—: (æ— )                                               â”‚ â”‚   â”‚
â”‚  â”‚ â”‚                                                 [ç¼–è¾‘å·¥ä½œæµ â†’]  â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚                              [+ æ·»åŠ è¿›ç¨‹ç»„]                                  â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜Ÿåˆ—æ‹“æ‰‘é¢„è§ˆ                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   [æ•°æ®è¯»å–ç»„ Ã—2] â”€â”€â”€â”€â–º [raw_data] â”€â”€â”€â”€â–º [æ•°æ®å¤„ç†ç»„ Ã—1]           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.4.2 è¿›ç¨‹å†…å·¥ä½œæµç¼–è¾‘å™¨ï¼ˆå­ç”»å¸ƒï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼–è¾‘è¿›ç¨‹ç»„: æ•°æ®è¯»å–ç»„                                      [â† è¿”å›] [ä¿å­˜] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          å­å·¥ä½œæµç”»å¸ƒ                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â”‚
â”‚  â”‚      â”‚ CsvLoader   â”‚         â”‚ MQProducer  â”‚                       â”‚   â”‚
â”‚  â”‚      â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚                       â”‚   â”‚
â”‚  â”‚      â”‚ path: ...   â”‚         â”‚ topic: ...  â”‚                       â”‚   â”‚
â”‚  â”‚      â”‚ threads: 4  â”‚         â”‚             â”‚                       â”‚   â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  èŠ‚ç‚¹é¢æ¿                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚  â”‚ ETL              â”‚                                                      â”‚
â”‚  â”‚ â”œâ”€ CsvLoader     â”‚                                                      â”‚
â”‚  â”‚ â”œâ”€ Transform     â”‚                                                      â”‚
â”‚  â”‚ â””â”€ DbSave        â”‚                                                      â”‚
â”‚  â”‚ MQ               â”‚                                                      â”‚
â”‚  â”‚ â”œâ”€ MQProducer    â”‚                                                      â”‚
â”‚  â”‚ â””â”€ MQConsumer    â”‚                                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.4.3 æ“ä½œæµç¨‹

```
1. åˆ›å»º ProcessSchedulerNode
   â””â”€â”€ åŒå‡»æ‰“å¼€è¿›ç¨‹ç¼–æ’é¢æ¿

2. ç‚¹å‡» [+ æ·»åŠ è¿›ç¨‹ç»„]
   â””â”€â”€ å¼¹å‡ºé…ç½®å¯¹è¯æ¡†
       â”œâ”€â”€ åç§°: "æ•°æ®è¯»å–"
       â”œâ”€â”€ è¿›ç¨‹æ•°: 2
       â”œâ”€â”€ çº¿ç¨‹æ•°: 4 (å¯é€‰ï¼Œéƒ¨åˆ†èŠ‚ç‚¹æ”¯æŒ)
       â””â”€â”€ ç¡®è®¤åˆ›å»º

3. ç‚¹å‡» [ç¼–è¾‘å·¥ä½œæµ â†’]
   â””â”€â”€ æ‰“å¼€å­ç”»å¸ƒ
       â”œâ”€â”€ ä»èŠ‚ç‚¹é¢æ¿æ‹–å…¥ CsvLoader
       â”œâ”€â”€ é…ç½® path, chunk_size
       â”œâ”€â”€ æ‹–å…¥ MQProducer
       â”œâ”€â”€ é…ç½® topic: raw_data
       â””â”€â”€ è¿çº¿ CsvLoader â†’ MQProducer

4. ç‚¹å‡» [å¤åˆ¶] å¿«é€Ÿåˆ›å»ºç›¸åŒé…ç½®çš„è¿›ç¨‹ç»„

5. ç‚¹å‡» [+ æ·»åŠ è¿›ç¨‹ç»„] åˆ›å»ºæ¶ˆè´¹è€…
   â””â”€â”€ ç¼–è¾‘å·¥ä½œæµ
       â”œâ”€â”€ æ‹–å…¥ MQConsumer (topic: raw_data)
       â”œâ”€â”€ æ‹–å…¥ FactorCalc
       â”œâ”€â”€ æ‹–å…¥ DbSave
       â””â”€â”€ è¿çº¿

6. ä¿å­˜å¹¶è¿è¡Œ
```

### 6.5 æ•°æ®æ¨¡å‹

```python
class ProcessGroup(BaseModel):
    """è¿›ç¨‹ç»„é…ç½®"""
    id: str
    name: str
    replicas: int = 1                    # è¿›ç¨‹æ•°
    threads: int = 1                     # çº¿ç¨‹æ•°ï¼ˆä¼ é€’ç»™æ”¯æŒçš„èŠ‚ç‚¹ï¼‰
    input_queue: str | None = None       # è¾“å…¥é˜Ÿåˆ—ï¼ˆæ¶ˆè´¹è€…ï¼‰
    output_queue: str | None = None      # è¾“å‡ºé˜Ÿåˆ—ï¼ˆç”Ÿäº§è€…ï¼‰
    workflow: list[NodeConfig]           # å†…éƒ¨å·¥ä½œæµèŠ‚ç‚¹åˆ—è¡¨


class NodeConfig(BaseModel):
    """èŠ‚ç‚¹é…ç½®"""
    id: str
    node_type: str                       # èŠ‚ç‚¹ç±»å‹ï¼Œå¦‚ "csv_loader"
    params: dict                         # èŠ‚ç‚¹å‚æ•°
    position: dict                       # UI ä½ç½® {x, y}


class ProcessSchedulerConfig(BaseModel):
    """è¿›ç¨‹è°ƒåº¦å™¨å®Œæ•´é…ç½®"""
    id: str
    name: str
    process_groups: list[ProcessGroup]
    mq_type: Literal["redis", "rocketmq"] = "redis"
    mq_config: dict                      # MQ è¿æ¥é…ç½®
```

### 6.6 æ¶ˆæ¯é˜Ÿåˆ—æŠ½è±¡å±‚

ä¸ºæ”¯æŒå¤šç§ MQ å®ç°ï¼Œè®¾è®¡ç»Ÿä¸€æ¥å£ï¼š

```python
# server/mq/base.py

class MQProducer(ABC):
    """æ¶ˆæ¯ç”Ÿäº§è€…æ¥å£"""
    @abstractmethod
    def send(self, topic: str, data: bytes) -> None: ...

    @abstractmethod
    def close(self) -> None: ...


class MQConsumer(ABC):
    """æ¶ˆæ¯æ¶ˆè´¹è€…æ¥å£"""
    @abstractmethod
    def subscribe(self, topic: str, group: str) -> None: ...

    @abstractmethod
    def poll(self, timeout: float = 1.0) -> Message | None: ...

    @abstractmethod
    def ack(self, message: Message) -> None: ...

    @abstractmethod
    def close(self) -> None: ...


# server/mq/redis_streams.py
class RedisStreamProducer(MQProducer):
    """Redis Streams å®ç°"""
    def send(self, topic: str, data: bytes):
        self.client.xadd(topic, {"data": data})


class RedisStreamConsumer(MQConsumer):
    """Redis Streams æ¶ˆè´¹è€…"""
    def poll(self, timeout: float = 1.0):
        result = self.client.xreadgroup(
            self.group, self.consumer_id,
            {self.topic: ">"}, count=1, block=int(timeout * 1000)
        )
        # ...


# server/mq/rocketmq.py (æœªæ¥æ‰©å±•)
class RocketMQProducer(MQProducer): ...
class RocketMQConsumer(MQConsumer): ...
```

### 6.7 MQ èŠ‚ç‚¹å®ç°

```python
# server/nodes/mq/producer.py

class MQProducerNode(BaseNode):
    """æ¶ˆæ¯é˜Ÿåˆ—ç”Ÿäº§è€…èŠ‚ç‚¹"""

    class Params(BaseModel):
        topic: str = Field(..., title="Topic åç§°")
        batch_size: int = Field(default=100, title="æ‰¹é‡å‘é€å¤§å°")
        serializer: Literal["parquet", "msgpack", "json"] = "parquet"

    @classmethod
    def metadata(cls):
        return {
            "name": "mq_producer",
            "title": "MQ ç”Ÿäº§è€…",
            "category": "mq",
            "description": "å°†æ•°æ®å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—",
        }

    def process(self, data: pd.DataFrame, context: dict) -> pd.DataFrame:
        producer = context["mq_producer"]

        # åºåˆ—åŒ–å¹¶å‘é€
        if self.params.serializer == "parquet":
            payload = data.to_parquet()
        elif self.params.serializer == "msgpack":
            payload = data.to_msgpack()
        else:
            payload = data.to_json().encode()

        producer.send(self.params.topic, payload)
        return data


# server/nodes/mq/consumer.py

class MQConsumerNode(BaseNode):
    """æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…èŠ‚ç‚¹ - ä½œä¸º Source èŠ‚ç‚¹"""

    class Params(BaseModel):
        topic: str = Field(..., title="Topic åç§°")
        group: str = Field(..., title="æ¶ˆè´¹è€…ç»„")
        deserializer: Literal["parquet", "msgpack", "json"] = "parquet"

    @classmethod
    def metadata(cls):
        return {
            "name": "mq_consumer",
            "title": "MQ æ¶ˆè´¹è€…",
            "category": "mq",
            "description": "ä»æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹æ•°æ®",
        }

    def stream(self, context: dict):
        """æŒç»­æ¶ˆè´¹ï¼Œyield DataFrame"""
        consumer = context["mq_consumer"]
        consumer.subscribe(self.params.topic, self.params.group)

        while True:
            msg = consumer.poll(timeout=5.0)
            if msg is None:
                # æ£€æŸ¥æ˜¯å¦æ”¶åˆ°ç»ˆæ­¢ä¿¡å·
                if context.get("shutdown"):
                    break
                continue

            # ååºåˆ—åŒ–
            if self.params.deserializer == "parquet":
                df = pd.read_parquet(io.BytesIO(msg.data))
            # ...

            yield df
            consumer.ack(msg)
```

### 6.8 è¿›ç¨‹è°ƒåº¦å™¨æ‰§è¡Œå¼•æ“

```python
# server/scheduler/process_scheduler.py

class ProcessScheduler:
    """è¿›ç¨‹è°ƒåº¦å™¨ - ç®¡ç†å¤šè¿›ç¨‹ç»„çš„ç”Ÿå‘½å‘¨æœŸ"""

    def __init__(self, config: ProcessSchedulerConfig, db_url: str):
        self.config = config
        self.db_url = db_url
        self.mq_factory = MQFactory(config.mq_type, config.mq_config)

    def run(self):
        """å¯åŠ¨æ‰€æœ‰è¿›ç¨‹ç»„"""
        processes = []

        for group in self.config.process_groups:
            for i in range(group.replicas):
                p = Process(
                    target=self._run_process_group,
                    args=(group, i)
                )
                p.start()
                processes.append(p)

        # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
        for p in processes:
            p.join()

    def _run_process_group(self, group: ProcessGroup, replica_id: int):
        """å•ä¸ªè¿›ç¨‹çš„æ‰§è¡Œé€»è¾‘"""
        # åˆå§‹åŒ– MQ è¿æ¥
        context = {
            "db_url": self.db_url,
            "mq_producer": self.mq_factory.create_producer() if group.output_queue else None,
            "mq_consumer": self.mq_factory.create_consumer() if group.input_queue else None,
            "threads": group.threads,
        }

        # å®ä¾‹åŒ–å·¥ä½œæµèŠ‚ç‚¹
        nodes = [
            NodeRegistry.create(cfg.node_type, cfg.params)
            for cfg in group.workflow
        ]

        # æ‰§è¡Œå·¥ä½œæµ
        runner = StreamRunner(nodes)
        runner.run(context)

        # æ¸…ç†
        if context["mq_producer"]:
            context["mq_producer"].close()
        if context["mq_consumer"]:
            context["mq_consumer"].close()
```

### 6.9 æ•°æ®åº“è¿æ¥ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ•°æ®åº“è¿æ¥æ¶æ„                                     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ è¿›ç¨‹ç»„ A-1  â”‚  â”‚ è¿›ç¨‹ç»„ A-2  â”‚  â”‚ è¿›ç¨‹ç»„ B-1  â”‚                         â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚                         â”‚
â”‚  â”‚ éœ€è¦DBæ—¶    â”‚  â”‚ éœ€è¦DBæ—¶    â”‚  â”‚ éœ€è¦DBæ—¶    â”‚                         â”‚
â”‚  â”‚ æ‰æ‹¿è¿æ¥    â”‚  â”‚ æ‰æ‹¿è¿æ¥    â”‚  â”‚ æ‰æ‹¿è¿æ¥    â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚         â”‚                â”‚                â”‚                                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                          â†“                                                  â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚                 â”‚   PgBouncer     â”‚  â† è¿æ¥æ± ä»£ç†                           â”‚
â”‚                 â”‚  pool_mode:     â”‚     transaction æ¨¡å¼                    â”‚
â”‚                 â”‚  transaction    â”‚     äº‹åŠ¡ç»“æŸå³å½’è¿˜                       â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                          â†“                                                  â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚                 â”‚   PostgreSQL    â”‚                                         â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®åŸåˆ™ï¼š
â”œâ”€ è¿›ç¨‹å†…æŒ‰éœ€è·å–è¿æ¥ï¼Œç”¨å®Œå³è¿˜
â”œâ”€ è¿æ¥ PgBouncer è€Œéç›´è¿ PostgreSQL
â”œâ”€ PgBouncer ä½¿ç”¨ transaction æ¨¡å¼ï¼Œæœ€å¤§åŒ–è¿æ¥å¤ç”¨
â””â”€ æ¯ä¸ªè¿›ç¨‹ pool_size=1 å³å¯ï¼ŒPgBouncer è´Ÿè´£å…¨å±€æ± åŒ–
```

### 6.10 MQ é€‰å‹å¯¹æ¯”

| ç‰¹æ€§ | Redis Streams | RocketMQ |
|-----|---------------|----------|
| **éƒ¨ç½²å¤æ‚åº¦** | ä½ï¼ˆå†…ç½®ï¼‰ | é«˜ï¼ˆç‹¬ç«‹æœåŠ¡ï¼‰ |
| **æ¶ˆè´¹ç»„** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **æ¶ˆæ¯ç¡®è®¤** | âœ… XACK | âœ… ACK |
| **æŒä¹…åŒ–** | âœ… AOF/RDB | âœ… ç£ç›˜ |
| **ååé‡** | ä¸­ï¼ˆ10ä¸‡/sï¼‰ | é«˜ï¼ˆç™¾ä¸‡/sï¼‰ |
| **äº‹åŠ¡æ¶ˆæ¯** | âŒ | âœ… |
| **å»¶è¿Ÿæ¶ˆæ¯** | âŒ | âœ… |
| **é€‚ç”¨è§„æ¨¡** | ä¸­å° | å¤§è§„æ¨¡ |

**å»ºè®®**ï¼š
- å¼€å‘/ä¸­å°è§„æ¨¡ï¼šRedis Streamsï¼ˆé›¶è¿ç»´ï¼‰
- ç”Ÿäº§/å¤§è§„æ¨¡ï¼šRocketMQï¼ˆé«˜å¯é ï¼‰

### 6.11 å®Œæ•´æ‰§è¡Œæµç¨‹

```
1. ç”¨æˆ·åœ¨ UI é…ç½® ProcessSchedulerNode
   â””â”€â”€ ä¿å­˜é…ç½®åˆ°æ•°æ®åº“

2. è§¦å‘æ‰§è¡Œ
   â””â”€â”€ API: POST /api/v1/scheduler/{id}/run

3. ProcessScheduler åˆå§‹åŒ–
   â”œâ”€â”€ åŠ è½½é…ç½®
   â”œâ”€â”€ åˆå§‹åŒ– MQ è¿æ¥å·¥å‚
   â””â”€â”€ åˆ›å»ºè¿›ç¨‹ç»„

4. å¯åŠ¨è¿›ç¨‹
   â”œâ”€â”€ è¿›ç¨‹ç»„ A (Ã—2): æ•°æ®è¯»å–
   â”‚   â”œâ”€â”€ è¿›ç¨‹ A-1: CsvLoader â†’ MQProducer
   â”‚   â””â”€â”€ è¿›ç¨‹ A-2: CsvLoader â†’ MQProducer
   â”‚
   â””â”€â”€ è¿›ç¨‹ç»„ B (Ã—1): æ•°æ®å¤„ç†
       â””â”€â”€ è¿›ç¨‹ B-1: MQConsumer â†’ FactorCalc â†’ DbSave

5. æ•°æ®æµè½¬
   â”œâ”€â”€ A-1, A-2 å¹¶è¡Œè¯»å– CSVï¼Œå‘é€åˆ° MQ
   â”œâ”€â”€ B-1 ä» MQ æ¶ˆè´¹ï¼Œå¤„ç†ï¼Œå­˜åº“
   â””â”€â”€ é˜Ÿåˆ—è‡ªåŠ¨èƒŒå‹ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º

6. å®Œæˆ
   â”œâ”€â”€ ç”Ÿäº§è€…å‘é€ END ä¿¡å·
   â”œâ”€â”€ æ¶ˆè´¹è€…æ”¶åˆ° END åé€€å‡º
   â””â”€â”€ è°ƒåº¦å™¨æ±‡æ€»çŠ¶æ€ï¼Œè¿”å›ç»“æœ
```
